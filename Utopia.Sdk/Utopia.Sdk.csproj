<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
      <PackageRequireLicenseAcceptance>true</PackageRequireLicenseAcceptance>
      <IsPackable>true</IsPackable>
      <Authors>MingMoe</Authors>
      <Description>A package that add some useful MSBuild tasks.</Description>
      <Copyright>Copyright Â©MingMoe 2023</Copyright>
      <GenerateDependencyFile>true</GenerateDependencyFile>
  </PropertyGroup>

    <!--Read version.txt file-->
    <PropertyGroup Condition="'$(VersionSuffix)' == ''">
        <Version>$([System.IO.File]::ReadAllText("$(ProjectDir)./version.txt"))</Version>
    </PropertyGroup>

    <PropertyGroup Condition="'$(VersionSuffix)' != ''">
        <Version>$([System.IO.File]::ReadAllText("./version.txt"))-$(VersionSuffix)</Version>
    </PropertyGroup>

    <!-- generate .dep.json -->
    <Target Name="AddBuildDependencyFileToBuiltProjectOutputGroupOutput" BeforeTargets="BuiltProjectOutputGroup" Condition=" '$(GenerateDependencyFile)' == 'true'">
        <ItemGroup>
            <BuiltProjectOutputGroupOutput Include="$(ProjectDepsFilePath)" TargetPath="$(ProjectDepsFileName)" FinalOutputPath="$(ProjectDepsFilePath)" />
        </ItemGroup>
    </Target>

    <!--replace our file-->
    <UsingTask TaskName="ReplaceFileText" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
        <ParameterGroup>
            <InputFilename ParameterType="System.String" Required="true" />
            <OutputFilename ParameterType="System.String" Required="true" />
            <MatchExpression ParameterType="System.String" Required="true" />
            <ReplacementText ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Reference Include="System.Core" />
            <Using Namespace="System" />
            <Using Namespace="System.IO" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
            File.WriteAllText(
                OutputFilename,
                Regex.Replace(File.ReadAllText(InputFilename), MatchExpression, ReplacementText)
                );
          ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="UpdateVersionInSdkFile" BeforeTargets="BeforeBuild" Inputs="$(ProjectDir)\build\Utopia.Sdk.props" Outputs="$(OutputPath)\build\Utopia.Sdk.props.fake">
        <ReplaceFileText InputFilename="$(ProjectDir)\build\Utopia.Sdk.props" OutputFilename="$(OutputPath)\Utopia.Sdk.props" MatchExpression="\$VERSION\$" ReplacementText="$(Version)" />
        <Message Importance="high" Text="generate Utopia.Sdk version $(Version)" />
    </Target>

    <ItemGroup>
      <None Remove="build\VersionReader.targets" />
    </ItemGroup>

    <ItemGroup>
        <Content Include="$(OutputPath)\Utopia.Sdk.props" PackagePath="build\" />
        <Content Include="$(ProjectDir)\build\Utopia.Sdk.targets" PackagePath="build\" />
        <Content Include="build\VersionReader.targets" PackagePath="build\" />
    </ItemGroup>

</Project>
